<!DOCTYPE html>
{% load static %}
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Gallery</title>
    <link rel="stylesheet" href="{% static 'salon/css/progressBar.css' %}">
  </head>
  <body>
    <div>
      <h2>입력한 텍스트와 맞는 작품을 생성합니다.</h2>
    </div>
    <div>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.js"></script>
      <script>
        var onceTimer;
        var step = 5;
        function progress_step() {
          document.getElementById('progressBar').value += step;
          if (document.getElementById('progressBar').value >= 99) {
            clearInterval(onceTimer);
            console.log('=================end')
          }
        }
        function progress_start() {
          var title = document.getElementById('title').value
          axios.post("/result_model/", {'text':title}) //post로 인풋데이터넣기
          .then( finish_model )
          .then(function () { alert("작품 생성이 완료되었습니다.")} )
          // .then(() => {location.href = "/result/"} )
          .catch(function (error) {console.log(error)} ) 
  
          onceTimer = setInterval(progress_step, 1000);
          
        }
        function finish_model(res) {
          clearInterval(onceTimer); 
          document.getElementById('progressBar').value = 100;

          console.log(res.data);
          img_file = res.data['img_file']
          img_tn_file = res.data['img_tn_file']
          mus_file = res.data['mus_file']
          title = document.getElementById('title').value
          console.log(img_file, img_tn, mus_file, title);

          var form = document.createElement('form'); // 폼객체 생성
          var img, img_tn, mus, txt;
          img = document.createElement('input'); // 값이 들어있는 녀석의 형식
          img.setAttribute('type', 'hidden'); // 값이 들어있는 녀석의 type
          img.setAttribute('name', 'img_file'); // 객체이름
          img.setAttribute('value', img_file); //객체값
          form.appendChild(img);

          img_tn = document.createElement('input');
          img_tn.setAttribute('type', 'hidden');
          img_tn.setAttribute('name', 'img_tn_file');
          img_tn.setAttribute('value', img_tn_file);
          form.appendChild(img_tn);
          
          mus = document.createElement('input');
          mus.setAttribute('type', 'hidden');
          mus.setAttribute('name', 'mus_file');
          mus.setAttribute('value', mus_file);
          form.appendChild(mus);
          
          txt = document.createElement('input');
          txt.setAttribute('type', 'hidden');
          txt.setAttribute('name', 'input_text');
          txt.setAttribute('value', title);
          form.appendChild(txt);

          form.setAttribute("charset", "UTF-8");
          form.setAttribute('method', 'post'); //get,post 가능
          form.setAttribute('action', "/result/"); //보내는 url
          document.body.appendChild(form);
          form.submit();
        }
    
      </script>
      <!-- <form action="{% url 'salon:result' %}" method='POST' enctype="multipart/form-data"> -->
        {% csrf_token %}
        <label for="name">Enter 4 to 30 characters:</label>
        <input type="text" id="title" name="title" required
         minlength="4" maxlength="30" size="40" placeholder="텍스트를 입력해주세요."><br>
        <button disabled id="btn_create" onclick="progress_start()">생성하기</button>
          <progress id="progressBar" value="0" min="0" max="100"></progress>
      <!-- </form> -->
    </div>
    <br/>
  <script type="text/javascript" src="{% static 'salon/js/createBtn.js' %}"></script>
  </body>
</html>
